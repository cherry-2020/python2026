# 聊天内容保存到数据库指南

本指南将帮助您使用 `chat_to_db.py` 脚本将聊天内容保存到 PostgreSQL 数据库中。

## 前提条件

在开始之前，请确保您已经：

1. 安装了 PostgreSQL 数据库
2. 安装了 Python 3.6 或更高版本

## 安装步骤

### 1. 安装必要的 Python 库

首先，您需要安装 `psycopg2-binary` 库，这是 Python 与 PostgreSQL 数据库交互的适配器：

```bash
pip install psycopg2-binary
```

### 2. 准备 PostgreSQL 数据库

确保您的 PostgreSQL 服务器已启动，并且您有适当的权限创建表和插入数据。

## 数据库连接设置

### 方法 1: 直接修改代码

打开 `chat_to_db.py` 文件，找到以下部分并修改为您的数据库连接信息：

```python
self.db_url = os.environ.get('DATABASE_URL', 'postgresql://postgres:password@localhost:5432/mydb')
```

将 `postgres:password@localhost:5432/mydb` 替换为您的实际数据库连接信息：
- `postgres`: 您的数据库用户名
- `password`: 您的数据库密码
- `localhost`: 数据库服务器地址（如果数据库在本地，保持不变）
- `5432`: 数据库端口号（PostgreSQL 默认端口为 5432）
- `mydb`: 您要使用的数据库名称

### 方法 2: 使用环境变量

您也可以不修改代码，而是通过设置环境变量来指定数据库连接信息：

在 Windows 命令提示符中：
```cmd
set DATABASE_URL=postgresql://用户名:密码@localhost:5432/数据库名
```

在 Windows PowerShell 中：
```powershell
$env:DATABASE_URL="postgresql://用户名:密码@localhost:5432/数据库名"
```

这种方法的优点是您不需要修改代码，并且可以在不重新编译或重新部署应用程序的情况下更改数据库连接信息。

## 使用方法

### 方法 1: 基本用法

以下是如何在您的聊天应用中使用 `ChatDatabase` 类的基本示例：

```python
from chat_to_db import ChatDatabase

# 创建数据库实例
chat_db = ChatDatabase()

# 连接到数据库
if chat_db.connect():
    # 保存聊天消息
    chat_db.save_chat("用户1", "你好，这是一条测试消息")
    chat_db.save_chat("用户2", "你好，收到了你的消息")
    
    # 获取聊天消息
    chats = chat_db.get_chats()
    for chat in chats:
        print(f"[{chat[2]}] {chat[0]}: {chat[1]}")
    
    # 关闭连接
    chat_db.close()
```

### 方法 2: 使用上下文管理器（推荐）

推荐使用 Python 的上下文管理器（`with` 语句）来自动管理数据库连接的打开和关闭：

```python
from chat_to_db import ChatDatabase

# 使用上下文管理器（自动连接和关闭）
try:
    with ChatDatabase() as chat_db:
        # 保存聊天消息
        chat_db.save_chat("用户1", "你好，这是一条测试消息")
        chat_db.save_chat("用户2", "你好，收到了你的消息")
        
        # 获取聊天消息
        chats = chat_db.get_chats()
        for chat in chats:
            print(f"[{chat[2]}] {chat[0]}: {chat[1]}")
except Exception as e:
    print(f"操作数据库时出错: {e}")
```

### 更多功能

#### 1. 自定义数据库连接

您还可以在创建 `ChatDatabase` 实例时直接指定数据库连接 URL：

```python
from chat_to_db import ChatDatabase

# 直接指定数据库连接 URL
chat_db = ChatDatabase('postgresql://用户名:密码@localhost:5432/数据库名')

# 使用上下文管理器
with chat_db:
    # ... 使用 chat_db ...
```

#### 2. 获取指定发送者的消息

您可以使用 `get_chats_by_sender` 方法获取特定用户发送的所有消息：

```python
with ChatDatabase() as chat_db:
    # 获取用户1发送的消息（最多50条）
    user1_chats = chat_db.get_chats_by_sender("用户1", limit=50)
    for chat in user1_chats:
        print(f"[{chat[2]}] {chat[0]}: {chat[1]}")
```

#### 3. 搜索包含关键词的消息

使用 `search_chats` 方法可以搜索包含特定关键词的消息：

```python
with ChatDatabase() as chat_db:
    # 搜索包含"测试"关键词的消息
    search_results = chat_db.search_chats("测试")
    for chat in search_results:
        print(f"[{chat[2]}] {chat[0]}: {chat[1]}")
```

## 脚本功能说明

`ChatDatabase` 类提供了以下主要方法：

1. `__init__(db_url=None)`: 初始化数据库连接配置
   - 参数: `db_url` - 可选，数据库连接 URL

2. `connect()`: 连接到数据库并创建聊天表（如果不存在）
   - 返回: 连接成功返回 `True`，失败返回 `False`
   - 特点: 包含更详细的错误处理，区分连接错误和编程错误

3. `save_chat(sender, message)`: 保存聊天消息到数据库
   - 参数: 
     - `sender` - 发送者名称
     - `message` - 聊天消息内容
   - 返回: 保存成功返回 `True`，失败返回 `False`

4. `get_chats(limit=100)`: 获取最近的聊天消息
   - 参数: `limit` - 可选，返回的最大消息数量，默认 100
   - 返回: 聊天消息列表，每条消息包含发送者、消息内容和时间戳

5. `get_chats_by_sender(sender, limit=100)`: 获取指定发送者的聊天消息
   - 参数: 
     - `sender` - 发送者名称
     - `limit` - 可选，返回的最大消息数量，默认 100
   - 返回: 符合条件的聊天消息列表

6. `search_chats(keyword, limit=100)`: 搜索包含关键词的聊天消息
   - 参数: 
     - `keyword` - 搜索关键词
     - `limit` - 可选，返回的最大消息数量，默认 100
   - 返回: 包含关键词的聊天消息列表

7. `close()`: 关闭数据库连接

8. 上下文管理器支持: 通过 `__enter__` 和 `__exit__` 方法支持 `with` 语句

## 数据库表结构

脚本会自动创建名为 `chat_messages` 的表（如果不存在），表结构如下：

```sql
CREATE TABLE IF NOT EXISTS chat_messages (
    id SERIAL PRIMARY KEY,
    sender VARCHAR(50) NOT NULL,
    message TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

- `id`: 自增主键
- `sender`: 消息发送者（最多 50 个字符）
- `message`: 消息内容
- `timestamp`: 消息发送时间戳，默认为当前时间

## 常见问题解决

### 1. 连接数据库失败

如果您在连接数据库时遇到问题，请检查以下几点：

- PostgreSQL 服务是否已启动（可以在任务管理器中查看）
- 数据库连接信息是否正确（用户名、密码、数据库名等）
- 防火墙是否允许连接到 PostgreSQL 端口（默认 5432）
- 您的用户是否有权限访问指定的数据库

脚本现在会提供更具体的错误信息，帮助您诊断问题：
- `OperationalError`: 通常表示无法连接到数据库服务器，可能是服务未启动或连接信息错误
- `ProgrammingError`: 通常表示数据库名称不存在或权限问题

### 2. 权限问题

如果遇到权限不足的错误，请确保您的数据库用户具有创建表和插入数据的权限。您可以使用 PostgreSQL 的 `GRANT` 命令来授予权限：

```sql
GRANT ALL PRIVILEGES ON DATABASE 数据库名 TO 用户名;
```

## 扩展建议

如果您想进一步增强此脚本的功能，可以考虑添加以下功能：

1. 用户认证系统
2. 消息类型区分（文本、图片、文件等）
3. 聊天会话管理
4. 消息加密
5. 分页获取大量聊天记录
6. 添加索引以提高查询性能
7. 支持多语言消息内容

## 示例代码运行说明

如果您直接运行 `chat_to_db.py` 文件，它将执行两个示例：

```bash
python chat_to_db.py
```

1. 基本用法示例：演示如何连接数据库、保存消息和获取消息
2. 上下文管理器示例：演示推荐的使用方式，以及如何使用搜索和按发送者筛选功能

请确保在运行示例之前已安装所有必要的库并正确配置了数据库连接信息。